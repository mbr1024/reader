# GitHub Actions å·¥ä½œæµ - æœåŠ¡ç«¯è‡ªåŠ¨éƒ¨ç½²
# è§¦å‘æ¡ä»¶: æ¨é€åˆ° main åˆ†æ”¯çš„ server/ ç›®å½•å˜æ›´

name: Deploy Server

on:
  push:
    branches:
      - main
    paths:
      - 'server/**'
      - '.github/workflows/deploy-server.yml'
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

env:
  SERVER_HOST: ${{ secrets.SERVER_HOST }}
  SERVER_USER: ${{ secrets.SERVER_USER }}
  SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
  APP_DIR: /opt/reader-server

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: ğŸ“¦ Install dependencies
        working-directory: ./server
        run: npm ci

      - name: ğŸ” Run linter
        working-directory: ./server
        run: npm run lint || true

      - name: ğŸ—ï¸ Build project
        working-directory: ./server
        run: npm run build

      - name: ğŸ“¤ Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            # åˆ›å»ºåº”ç”¨ç›®å½•
            mkdir -p ${{ env.APP_DIR }}
            
            # å®‰è£… Docker (å¦‚æœæœªå®‰è£…)
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              curl -fsSL https://get.docker.com | sh
              systemctl enable docker
              systemctl start docker
            fi
            
            # å®‰è£… Docker Compose (å¦‚æœæœªå®‰è£…)
            if ! command -v docker compose &> /dev/null; then
              echo "Installing Docker Compose..."
              apt-get update && apt-get install -y docker-compose-plugin
            fi

      - name: ğŸ“‚ Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          source: "server/"
          target: ${{ env.APP_DIR }}
          strip_components: 1

      - name: ğŸš€ Run deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            cd ${{ env.APP_DIR }}
            
            # æ„å»ºé•œåƒ
            echo "ğŸ—ï¸ Building Docker image..."
            docker build -t reader-server:latest .
            
            # å¯åŠ¨æœåŠ¡
            echo "ğŸš€ Starting services..."
            docker compose -f docker-compose.prod.yml down --remove-orphans || true
            docker compose -f docker-compose.prod.yml up -d
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ Waiting for services..."
            sleep 15
            
            # æ£€æŸ¥çŠ¶æ€
            echo "ğŸ“Š Service status:"
            docker compose -f docker-compose.prod.yml ps
            
            # æ¸…ç†æ—§é•œåƒ
            docker image prune -f

      - name: âœ… Deployment complete
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Server: http://${{ secrets.SERVER_HOST }}:3000"
